<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no" />
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/zyUpload.css">
  <script src="../js/jquery-1.9.1.js"></script>
  <script src="../js/commen.js"></script>
  <script src="../js/rem.js"></script>
  <script type="text/javascript" src="../js/zyFile.js"></script>
  <script type="text/javascript" src="../js/zyUpload.js"></script>
  <title>我的</title>
</head>

<body>
<div class="part">
  <form method="post"  enctype="multipart/form-data" id="infoForm">
    <ul class="user_main">
      <li>昵 称 <input id="name" class="l_input text_right" type="text"></li>
      <li>头 像
        <div class="j_arrow fr">
          <p class="a_basic_head" style="display: inline-block;">
            <img style="height: 0.84rem;width: 0.84rem;" src="../images/add_img.png" id="headlogo">
          </p>
          <input type="file" name="file" onchange="imgPreview(this)" id="file" style="display: none">
        </div>
      </li>
    </ul>
    <div class="div_botm_btn">
      <input type="button" value="保存" class="b_mom_btn">
    </div>
  </form>
</div>
<div class="b_reminder-msg"><div class="b-msg"></div></div>
<script>
  var loginData = get('loginData');
  var $name = $('#name');
  var $avator = $('#headlogo');
  var $msg = $('.b-msg');
  
  function imgPreview(fileDom){
    //判断是否支持FileReader
    if (window.FileReader) {
      var reader = new FileReader();
    } else {
      alert("您的设备不支持图片预览功能，如需该功能请升级您的设备！");
    }
    //获取文件
    var file = fileDom.files[0];
    var imageType = /^image\//;
    //是否是图片
    if (!imageType.test(file.type)) {
      alert("请选择图片！");
      return;
    }
    //读取完成
    reader.onload = function(e) {
      //获取图片dom
      var img = document.getElementById("headlogo");
      //图片路径设置为读取的图片
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }
  
  $(".a_basic_head").on('click', function () {
    $("#file").click();
  });
  
  var publish_type = getParam("publish_type"),
    imgData = [];
  //上传图片初始化
  $(function(){
    // 初始化插件
    $("#imgUpload").zyUpload({
      width             :   "",                 // 宽度
      height            :   "",                 // 宽度
      itemWidth        :   "1rem",                 // 文件项的宽度
      itemHeight       :   "1rem",                 // 文件项的高度
      url               :  '',  // 上传文件的路径
      multiple         :   true,                    // 是否可以多个文件上传
      dragDrop         :   false,                    // 是否可以拖动上传文件
      del               :   true,                    // 是否可以删除文件
      finishDel        :   true,  				  // 是否在上传文件完成后删除预览
      /* 外部获得的回调接口 （备注：此处不能用，需要在zyUpload.js中设置）*/
      onSelect: function(files, allFiles){                    // 选择文件的回调方法
//                    console.info("当前选择了以下文件：");
//                    console.info(files);
//                    console.info("之前没上传的文件：");
//                    console.info(allFiles);
      },
      onDelete: function(file, surplusFiles){                     // 删除一个文件的回调方法
//                    console.info("当前删除了此文件：");
//                    console.info(file);
//                    console.info("当前剩余的文件：");
//                    console.info(surplusFiles);
      },
      onSuccess: function(file, response){                    // 文件上传成功的回调方法
//                    console.info("此文件上传成功：");
//                    console.info(file);
//                    console.info("0000000000000");
//					console.info(response);
      },
      onFailure: function(file){                    // 文件上传失败的回调方法
//                    console.info("此文件上传失败：");
//                    console.info(file);
      },
      onComplete: function(responseInfo){           // 上传完成的回调方法
//                    console.info("文件上传完成");
//                    console.info(responseInfo);
      }
    });
  });
  
  // init data
  if (loginData) {
    $name.val(loginData.data.name);
    $avator.attr('src', (loginData.data.head_image ? avatorUrl + loginData.data.head_image : '../images/add_img.png'));
  }

  $('.b_mom_btn').on('click', function () {
    var name = $('#name').val();
    var form = new FormData(document.getElementById("infoForm"));
    form.append('name', name);
    form.append('i_ui_identifier', loginData.data.i_ui_identifier);
    form.append('password', loginData.data.password);
    
    $.ajax({
      url:AjaxUrl + 'EditPersonInfo',
      type:'POST',
      dataType:'json',
      data: form,
      cache: false,
      processData: false,
      contentType: false,
      success: function(data){
        
        if (data.status === 'success') {
          $msg.html(data.Msg).show().delay(1000).fadeOut();
          
          $.ajax({
            url:AjaxUrl+'Login',
            type:'POST',
            dataType:'json',
            data:{
              "mobile": get('mobile').data,
              "password": loginData.data.password,
              "i_login_resourse":1
            },
            success: function(data){
              
              if (data.status === 'success') {
                set('loginData', data.data[0]);
                setTimeout(function () {
                  location.href = 'user-index.html';
                }, 1500)
                
              } else {
                localStorage.clear();
                location.href = '../login.html';

              }
              
            }
          })
          
        } else {
          
          $msg.empty()
          $msg.html(data.Msg).show().delay(1000).fadeOut();
        }
      }
    })
    
  });
  
</script>
</body>


</html>
